<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìé Upload & Analyze Battery Data</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.95em;
        }

        .results-section {
            display: none;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-line {
            padding: 5px 0;
            border-bottom: 1px solid #34495e;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-excellent { background: #2ecc71; color: white; }
        .badge-good { background: #f39c12; color: white; }
        .badge-fair { background: #e67e22; color: white; }
        .badge-poor { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìé Upload & Analyze Battery Data</h1>
            <p>Upload your CSV file to analyze battery health in real-time</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <h2>Drag & Drop CSV File Here</h2>
                <p style="margin: 15px 0; color: #7f8c8d;">or</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    üìÇ Browse Files
                </button>
                <input type="file" id="fileInput" accept=".csv" />
                <p style="margin-top: 20px; font-size: 0.9em; color: #95a5a6;">
                    Expected format: RFID, RTC_Time, Total_Voltage, C1, C2, C3, C4, C5, C6
                </p>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <h2>üîÑ Processing Data...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="log" id="logContainer"></div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Charts -->
            <div class="chart-container">
                <h2>üîã Battery Health Overview</h2>
                <div id="chart1"></div>
            </div>

            <div class="chart-container">
                <h2>üìä Status Distribution</h2>
                <div id="chart2"></div>
            </div>

            <div class="chart-container">
                <h2>üîÑ Configuration Analysis</h2>
                <div id="chart3"></div>
            </div>

            <div class="chart-container">
                <h2>üìà Detailed Pack Table</h2>
                <div id="tableContainer"></div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" onclick="downloadResults()">
                    üíæ Download Results CSV
                </button>
                <button class="btn" onclick="location.reload()">
                    üîÑ Analyze Another File
                </button>
            </div>
        </div>
    </div>

    <script>
        let analysisResults = null;
        let packStats = [];

        // Setup drag and drop
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            log(message);
        }

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('‚ö†Ô∏è Please upload a CSV file');
                return;
            }

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logContainer').innerHTML = '';
            updateProgress(10, `üìÅ Loading file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    updateProgress(30, `‚úÖ Parsed ${results.data.length} rows`);
                    processData(results.data);
                },
                error: function(error) {
                    log(`‚ùå Error parsing CSV: ${error.message}`, 'error');
                }
            });
        }

        function voltageToSoc(voltage) {
            if (voltage >= 4.2) return 100;
            if (voltage <= 3.3) return 0;
            if (voltage > 3.7) return 50 + 50 * (voltage - 3.7) / 0.5;
            return 50 * (voltage - 3.3) / 0.4;
        }

        function processData(data) {
            updateProgress(40, 'üî¨ Analyzing battery data...');

            // Extract unique packs
            const packs = {};
            const cellCols = ['C1', 'C2', 'C3', 'C4', 'C5', 'C6'];

            data.forEach(row => {
                const rfid = row.RFID;
                if (!rfid) return;

                if (!packs[rfid]) {
                    packs[rfid] = {
                        readings: [],
                        config: parseInt(rfid.match(/(\d+)S/)?.[1] || 3)
                    };
                }

                // Calculate cell metrics
                const voltages = cellCols.slice(0, packs[rfid].config)
                    .map(c => parseFloat(row[c]))
                    .filter(v => v > 0);

                if (voltages.length > 0) {
                    const vMax = Math.max(...voltages);
                    const vMin = Math.min(...voltages);
                    const vAvg = voltages.reduce((a, b) => a + b, 0) / voltages.length;
                    const imbalance = vMax - vMin;

                    packs[rfid].readings.push({
                        time: row.RTC_Time,
                        totalV: row.Total_Voltage,
                        vAvg,
                        vMin,
                        vMax,
                        imbalance,
                        lowVoltage: vMin < 3.5,
                        criticalVoltage: vMin < 3.3,
                        highImbalance: imbalance > 0.1
                    });
                }
            });

            updateProgress(60, `üì¶ Found ${Object.keys(packs).length} battery packs`);
            calculatePackStats(packs);
        }

        function calculatePackStats(packs) {
            updateProgress(70, 'üìà Computing health metrics...');

            packStats = [];

            Object.entries(packs).forEach(([rfid, pack]) => {
                if (pack.readings.length === 0) return;

                const readings = pack.readings;
                const avgImbalance = readings.reduce((sum, r) => sum + r.imbalance, 0) / readings.length;
                const maxImbalance = Math.max(...readings.map(r => r.imbalance));
                const lowVEvents = readings.filter(r => r.lowVoltage).length;
                const criticalVEvents = readings.filter(r => r.criticalVoltage).length;
                const highImbEvents = readings.filter(r => r.highImbalance).length;

                // Estimate cycles (voltage drops > 0.5V)
                let cycles = 1;
                for (let i = 1; i < readings.length; i++) {
                    if (readings[i].totalV - readings[i-1].totalV < -0.5) cycles++;
                }

                // Calculate voltage degradation
                const initialV = readings.slice(0, Math.min(10, readings.length))
                    .reduce((sum, r) => sum + r.vAvg, 0) / Math.min(10, readings.length);
                const recentV = readings.slice(-Math.min(10, readings.length))
                    .reduce((sum, r) => sum + r.vAvg, 0) / Math.min(10, readings.length);
                const degradation = Math.max(0, ((initialV - recentV) / initialV) * 100);

                // Calculate SoH
                let soh = 100;
                soh -= degradation * 2;
                soh -= Math.min(avgImbalance * 200, 30);
                soh -= Math.min(criticalVEvents * 5, 20);
                soh -= Math.min(cycles * 0.5, 15);
                soh = Math.max(0, Math.min(100, soh));

                // Determine status
                let status, statusClass;
                if (soh >= 85) {
                    status = 'üü¢ EXCELLENT';
                    statusClass = 'badge-excellent';
                } else if (soh >= 70) {
                    status = 'üü° GOOD';
                    statusClass = 'badge-good';
                } else if (soh >= 50) {
                    status = 'üü† FAIR';
                    statusClass = 'badge-fair';
                } else {
                    status = 'üî¥ POOR';
                    statusClass = 'badge-poor';
                }

                // Risk flags
                const flags = [];
                if (criticalVEvents > 0) flags.push('CRITICAL_VOLTAGE');
                if (maxImbalance > 0.2) flags.push('HIGH_IMBALANCE');
                if (degradation > 10) flags.push('VOLTAGE_DROP');
                if (cycles > 50) flags.push('HIGH_CYCLES');

                packStats.push({
                    rfid,
                    config: pack.config,
                    readings: readings.length,
                    avgVoltage: (readings.reduce((s, r) => s + r.totalV, 0) / readings.length).toFixed(2),
                    avgImbalance: avgImbalance.toFixed(3),
                    maxImbalance: maxImbalance.toFixed(3),
                    lowVEvents,
                    criticalVEvents,
                    highImbEvents,
                    cycles,
                    degradation: degradation.toFixed(1),
                    soh: soh.toFixed(1),
                    status,
                    statusClass,
                    flags: flags.join(', ') || 'NONE'
                });
            });

            updateProgress(90, `‚úÖ Analysis complete for ${packStats.length} packs`);
            displayResults();
        }

        function displayResults() {
            updateProgress(95, 'üí° Generating visualizations...');

            // Calculate fleet stats
            const totalPacks = packStats.length;
            const avgSoh = (packStats.reduce((s, p) => s + parseFloat(p.soh), 0) / totalPacks).toFixed(1);
            const criticalPacks = packStats.filter(p => parseFloat(p.soh) < 70).length;
            const totalReadings = packStats.reduce((s, p) => s + p.readings, 0);

            // Display stats cards
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üîã</div>
                    <div class="stat-value">${totalPacks}</div>
                    <div class="stat-label">Battery Packs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üü¢</div>
                    <div class="stat-value">${avgSoh}%</div>
                    <div class="stat-label">Average SoH</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-value">${criticalPacks}</div>
                    <div class="stat-label">Need Attention</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value">${totalReadings.toLocaleString()}</div>
                    <div class="stat-label">Total Readings</div>
                </div>
            `;

            // Create visualizations
            createCharts();
            createTable();

            updateProgress(100, 'üéâ All done! Scroll down to view results.');
            
            setTimeout(() => {
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        function createCharts() {
            // Chart 1: Health Overview Scatter
            const trace1 = {
                x: packStats.map(p => parseFloat(p.avgImbalance)),
                y: packStats.map(p => parseFloat(p.soh)),
                mode: 'markers',
                type: 'scatter',
                text: packStats.map(p => p.rfid),
                marker: {
                    size: packStats.map(p => p.cycles / 2 + 5),
                    color: packStats.map(p => parseFloat(p.soh)),
                    colorscale: 'RdYlGn',
                    showscale: true,
                    colorbar: { title: 'SoH %' }
                },
                hovertemplate: '<b>%{text}</b><br>SoH: %{y:.1f}%<br>Imbalance: %{x:.3f}V<extra></extra>'
            };

            const layout1 = {
                title: 'Battery Health vs Cell Imbalance',
                xaxis: { title: 'Average Cell Imbalance (V)' },
                yaxis: { title: 'State of Health (%)' },
                hovermode: 'closest',
                shapes: [
                    { type: 'line', x0: 0.1, x1: 0.1, y0: 0, y1: 100, line: { color: 'red', dash: 'dash' } },
                    { type: 'line', x0: 0, x1: Math.max(...packStats.map(p => parseFloat(p.avgImbalance))), y0: 70, y1: 70, line: { color: 'orange', dash: 'dash' } }
                ]
            };

            Plotly.newPlot('chart1', [trace1], layout1);

            // Chart 2: Status Distribution Pie
            const statusCounts = {};
            packStats.forEach(p => {
                statusCounts[p.status] = (statusCounts[p.status] || 0) + 1;
            });

            const trace2 = {
                labels: Object.keys(statusCounts),
                values: Object.values(statusCounts),
                type: 'pie',
                marker: {
                    colors: ['#2ecc71', '#f39c12', '#e67e22', '#e74c3c']
                }
            };

            Plotly.newPlot('chart2', [trace2], { title: 'Fleet Health Status Distribution' });

            // Chart 3: SoH by Configuration Box Plot
            const configs = [...new Set(packStats.map(p => p.config))].sort((a, b) => a - b);
            const traces3 = configs.map(config => {
                const configPacks = packStats.filter(p => p.config === config);
                return {
                    y: configPacks.map(p => parseFloat(p.soh)),
                    type: 'box',
                    name: `${config}S`,
                    boxmean: 'sd'
                };
            });

            Plotly.newPlot('chart3', traces3, {
                title: 'State of Health by Configuration',
                yaxis: { title: 'SoH (%)' }
            });
        }

        function createTable() {
            const sorted = [...packStats].sort((a, b) => parseFloat(a.soh) - parseFloat(b.soh));
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>RFID</th>
                            <th>Config</th>
                            <th>SoH %</th>
                            <th>Status</th>
                            <th>Avg Imbalance</th>
                            <th>Cycles</th>
                            <th>Critical Events</th>
                            <th>Risk Flags</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach(pack => {
                tableHTML += `
                    <tr>
                        <td><strong>${pack.rfid}</strong></td>
                        <td>${pack.config}S</td>
                        <td><strong>${pack.soh}%</strong></td>
                        <td><span class="badge ${pack.statusClass}">${pack.status}</span></td>
                        <td>${pack.avgImbalance}V</td>
                        <td>${pack.cycles}</td>
                        <td>${pack.criticalVEvents}</td>
                        <td><small>${pack.flags}</small></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        function downloadResults() {
            let csv = 'RFID,Config,SoH_Percent,Status,Avg_Imbalance,Max_Imbalance,Cycles,Critical_Events,Risk_Flags\n';
            
            packStats.forEach(pack => {
                csv += `${pack.rfid},${pack.config},${pack.soh},${pack.status},${pack.avgImbalance},${pack.maxImbalance},${pack.cycles},${pack.criticalVEvents},"${pack.flags}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `battery_analysis_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>